{{- range $service := .Values.services }}
apiVersion: v1
kind: Service
metadata:
  name: {{ $service.name }}
  {{- if eq $service.type "LoadBalancer" }}
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-name: {{ $service.name }}
    service.beta.kubernetes.io/aws-load-balancer-type: external
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: "2" 
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "30"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "HTTP"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "traffic-port"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout: "10"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: {{ $service.healthCheckPath }}
    # service.beta.kubernetes.io/aws-load-balancer-access-log-enabled: "true"
    # service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name: {{ printf "nlb-logs.%s.oneof.com" $service.env }}
    # service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix: {{ $service.name }}
  {{- end}}
  labels:
    app.kubernetes.io/name: {{ $service.name }}
    {{- include "deployment.labels" $ | nindent 4 }}
spec:
  type: {{ $service.type }}
  ports:
    - port: {{ $service.servicePort }}
      targetPort: {{ $service.containerPort }}
      protocol: {{ $service.protocol }}
      name: {{ $service.servicePortName }}
  selector:
    {{- include "deployment.selectorLabels" $ | nindent 4 }}
{{- end }}
